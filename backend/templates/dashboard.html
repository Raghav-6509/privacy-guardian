<!DOCTYPE html>
<html>
  <head>
    <title>Privacy Guardian Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
      }
      
      .header {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
      }
      
      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }
      
      .nav-tabs {
        display: flex;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
      }
      
      .nav-tab {
        flex: 1;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        color: #64748b;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
      }
      
      .nav-tab.active {
        color: #2563eb;
        background: white;
        border-bottom-color: #2563eb;
      }
      
      .nav-tab:hover {
        background: #f1f5f9;
        color: #2563eb;
      }
      
      .tab-content {
        display: none;
        padding: 30px;
      }
      
      .tab-content.active {
        display: block;
      }
      
      .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .stat-card {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid #e2e8f0;
        transition: transform 0.3s ease;
      }
      
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      }
      
      .stat-card h3 {
        color: #64748b;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
      }
      
      .stat-card .value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 5px;
      }
      
      .stat-card .score {
        color: #2563eb;
      }
      
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
      }
      
      .chart-container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
      }
      
      .chart-container h3 {
        color: #1e293b;
        margin-bottom: 20px;
        font-size: 1.3rem;
        font-weight: 600;
      }
      
      .advice-section {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        padding: 25px;
        border-radius: 15px;
        border-left: 5px solid #f59e0b;
        margin-bottom: 30px;
      }
      
      .advice-section h3 {
        color: #92400e;
        margin-bottom: 15px;
        font-size: 1.3rem;
      }
      
      .advice-list {
        list-style: none;
      }
      
      .advice-list li {
        color: #92400e;
        margin-bottom: 10px;
        padding-left: 20px;
        position: relative;
      }
      
      .advice-list li:before {
        content: "üí°";
        position: absolute;
        left: 0;
      }
      
      /* Dashboard Action Center Styles */
      .action-center {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        padding: 25px;
        border-radius: 15px;
        border-left: 5px solid #f59e0b;
        margin-bottom: 30px;
      }
      
      .action-center h3 {
        color: #92400e;
        margin-bottom: 10px;
        font-size: 1.3rem;
      }
      
      .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }
      
      .action-btn {
        background: #f59e0b;
        color: white;
        border: none;
        border-radius: 10px;
        padding: 15px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
      }
      
      .action-btn:hover {
        background: #d97706;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
      }
      
      .action-btn:active {
        transform: translateY(0);
      }
      
      .action-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .btn-icon {
        font-size: 18px;
      }
      
      .btn-text {
        font-size: 14px;
      }
      
      .action-status {
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        font-size: 13px;
        text-align: center;
        min-height: 20px;
        font-weight: 500;
      }
      
      .action-status.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
      }
      
      .action-status.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
      }
      
      .action-status.loading {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #3b82f6;
      }
      
      .tabs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      
      .heatmap-container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
      }
      
      .heatmap-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 25px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 10px;
      }
      
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: #64748b;
      }
      
      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
      }
      
      .legend-color.high-risk {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }
      
      .legend-color.medium-risk {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }
      
      .legend-color.low-risk {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      }
      
      .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      
      .heatmap-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }
      
      .heatmap-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      }
      
      .heatmap-item.high-risk {
        border-left: 4px solid #ef4444;
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      }
      
      .heatmap-item.medium-risk {
        border-left: 4px solid #f59e0b;
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      }
      
      .heatmap-item.low-risk {
        border-left: 4px solid #22c55e;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      }
      
      .heatmap-domain {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 8px;
        font-size: 1rem;
      }
      
      .heatmap-title {
        color: #64748b;
        font-size: 0.85rem;
        margin-bottom: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .heatmap-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 10px;
      }
      
      .heatmap-stat {
        text-align: center;
        padding: 6px;
        background: rgba(255,255,255,0.7);
        border-radius: 6px;
        font-size: 0.8rem;
      }
      
      .heatmap-stat .label {
        color: #64748b;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .heatmap-stat .value {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.9rem;
      }
      
      .heatmap-score {
        text-align: center;
        margin-top: 10px;
        padding: 8px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1.1rem;
      }
      
      .heatmap-score.high-risk {
        background: #fee2e2;
        color: #dc2626;
      }
      
      .heatmap-score.medium-risk {
        background: #fef3c7;
        color: #d97706;
      }
      
      .heatmap-score.low-risk {
        background: #dcfce7;
        color: #16a34a;
      }
      
      .tab-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .tab-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-color: #2563eb;
      }
      
      .tab-card.selected {
        border-color: #2563eb;
        background: #eff6ff;
      }
      
      .tab-title {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 8px;
        font-size: 1.1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .tab-domain {
        color: #64748b;
        font-size: 0.9rem;
        margin-bottom: 15px;
      }
      
      .tab-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        text-align: center;
      }
      
      .tab-stat {
        background: #f8fafc;
        padding: 10px;
        border-radius: 8px;
      }
      
      .tab-stat .label {
        font-size: 0.8rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .tab-stat .value {
        font-weight: 600;
        color: #1e293b;
        font-size: 1.1rem;
      }
      
      .tab-score {
        text-align: center;
        margin-top: 15px;
        padding: 10px;
        background: #f0f9ff;
        border-radius: 8px;
        border: 1px solid #0ea5e9;
      }
      
      .tab-score .score-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0c4a6e;
      }
      
      .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
      }
      
      .no-data h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }
      
      .loading {
        text-align: center;
        padding: 40px;
        color: #64748b;
      }
      
      @media (max-width: 768px) {
        .nav-tabs {
          flex-direction: column;
        }
        
        .charts-grid {
          grid-template-columns: 1fr;
        }
        
        .tabs-grid {
          grid-template-columns: 1fr;
        }
        
        .header h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üõ°Ô∏è Privacy Guardian</h1>
        <p>Comprehensive Privacy Analysis Dashboard</p>
      </div>
      
      <div class="nav-tabs">
        <div class="nav-tab active" data-tab="overview">Overview</div>
        <div class="nav-tab" data-tab="tabs">Individual Tabs</div>
        <div class="nav-tab" data-tab="heatmap">Privacy Heatmap</div>
      </div>
      
      <div id="overview" class="tab-content active">
        <div class="loading" id="overviewLoading">Loading overview data...</div>
        <div id="overviewContent" style="display: none;">
          <div class="overview-grid">
            <div class="stat-card">
              <h3>Overall Privacy Score</h3>
              <div class="value score" id="overallScore">--</div>
            </div>
            <div class="stat-card">
              <h3>Tabs Scanned</h3>
              <div class="value" id="tabsScanned">--</div>
            </div>
            <div class="stat-card">
              <h3>Total Cookies</h3>
              <div class="value" id="totalCookies">--</div>
            </div>
            <div class="stat-card">
              <h3>Total Trackers</h3>
              <div class="value" id="totalTrackers">--</div>
            </div>
            <div class="stat-card">
              <h3>Total Permissions</h3>
              <div class="value" id="totalPermissions">--</div>
            </div>
          </div>
          
          <div class="charts-grid">
            <div class="chart-container">
              <h3>Privacy Score Gauge</h3>
              <canvas id="scoreGauge" width="300" height="300"></canvas>
            </div>
            <div class="chart-container">
              <h3>Risk Breakdown</h3>
              <canvas id="breakdownChart" width="300" height="300"></canvas>
            </div>
          </div>
          
          <div class="advice-section">
            <h3>ü§ñ AI Privacy Recommendations</h3>
            <ul id="aiAdviceList" class="advice-list"></ul>
          </div>
          
          <!-- Privacy Action Center -->
          <div class="action-center">
            <h3>üõ†Ô∏è Privacy Action Center</h3>
            <p style="color: #64748b; margin-bottom: 20px; font-size: 0.9rem;">Take immediate action to improve your privacy</p>
            <div class="action-buttons">
              <button id="dashboardClearCookies" class="action-btn">
                <span class="btn-icon">üßπ</span>
                <span class="btn-text">Clear Cookies</span>
              </button>
              <button id="dashboardBlockTrackers" class="action-btn">
                <span class="btn-icon">üö´</span>
                <span class="btn-text">Block Trackers</span>
              </button>
              <button id="dashboardOptimize" class="action-btn">
                <span class="btn-icon">‚ö°</span>
                <span class="btn-text">Optimize Settings</span>
              </button>
            </div>
            <div id="dashboardActionStatus" class="action-status"></div>
          </div>
          
          <div class="chart-container">
            <h3>Privacy Score History</h3>
            <canvas id="scoreChart" width="600" height="300"></canvas>
          </div>
        </div>
      </div>
      
      <div id="tabs" class="tab-content">
        <div class="loading" id="tabsLoading">Loading individual tab data...</div>
        <div id="tabsContent" style="display: none;">
          <h3 style="margin-bottom: 20px; color: #1e293b;">Individual Tab Analysis</h3>
          <div id="tabsGrid" class="tabs-grid"></div>
        </div>
      </div>
      
      <div id="heatmap" class="tab-content">
        <div class="loading" id="heatmapLoading">Loading privacy heatmap...</div>
        <div id="heatmapContent" style="display: none;">
          <h3 style="margin-bottom: 20px; color: #1e293b;">Privacy Heatmap of Visited Sites</h3>
          <div class="heatmap-container">
            <div class="heatmap-legend">
              <div class="legend-item">
                <div class="legend-color high-risk"></div>
                <span>High Risk (0-40)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color medium-risk"></div>
                <span>Medium Risk (40-70)</span>
              </div>
              <div class="legend-item">
                <div class="legend-color low-risk"></div>
                <span>Low Risk (70-100)</span>
              </div>
            </div>
            <div id="heatmapGrid" class="heatmap-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentTab = 'overview';
      let allTabsData = null;
      
      function switchTab(tabName) {
        // Update nav tabs
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Update content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        
        currentTab = tabName;
        
        if (tabName === 'tabs' && allTabsData) {
          renderTabsGrid();
        }
        if (tabName === 'heatmap') {
          loadHeatmapData();
        }
      }
      
      // Add event listeners for tab navigation
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
          });
        });
      });
      
      async function loadOverviewData() {
        try {
          const res = await fetch('/all_tabs_history');
          const data = await res.json();
          
          if (data.latest && data.latest.overall) {
            allTabsData = data;
            renderOverview(data);
            document.getElementById('overviewLoading').style.display = 'none';
            document.getElementById('overviewContent').style.display = 'block';
          } else {
            // Fallback to regular history
            const fallbackRes = await fetch('/history');
            const fallbackData = await fallbackRes.json();
            if (fallbackData.latest) {
              renderFallbackOverview(fallbackData);
              document.getElementById('overviewLoading').style.display = 'none';
              document.getElementById('overviewContent').style.display = 'block';
            } else {
              document.getElementById('overviewLoading').innerHTML = '<div class="no-data"><h3>No scan data available</h3><p>Please run a scan from the extension first.</p></div>';
            }
          }
        } catch (e) {
          console.error('Error loading overview data:', e);
          document.getElementById('overviewLoading').innerHTML = '<div class="no-data"><h3>Error loading data</h3><p>Please try again later.</p></div>';
        }
      }
      
      function renderOverview(data) {
        const latest = data.latest;
        const overall = latest.overall;
        
        document.getElementById('overallScore').textContent = overall.privacy_score || '--';
        document.getElementById('tabsScanned').textContent = overall.tabs_scanned || '--';
        document.getElementById('totalCookies').textContent = overall.total_cookies || '--';
        document.getElementById('totalTrackers').textContent = overall.total_trackers || '--';
        document.getElementById('totalPermissions').textContent = (overall.total_permissions || []).length;
        
        // AI Advice
        const adviceList = document.getElementById('aiAdviceList');
        adviceList.innerHTML = '';
        (latest.ai_advice || []).forEach(advice => {
          const li = document.createElement('li');
          li.textContent = advice;
          adviceList.appendChild(li);
        });
        
        // Charts
        renderCharts(overall, data.history);
      }
      
      function renderFallbackOverview(data) {
        const latest = data.latest;
        
        document.getElementById('overallScore').textContent = latest.score || '--';
        document.getElementById('tabsScanned').textContent = '1';
        document.getElementById('totalCookies').textContent = '--';
        document.getElementById('totalTrackers').textContent = '--';
        document.getElementById('totalPermissions').textContent = '--';
        
        // AI Advice
        const adviceList = document.getElementById('aiAdviceList');
        adviceList.innerHTML = '';
        (latest.ai_advice || []).forEach(advice => {
          const li = document.createElement('li');
          li.textContent = advice;
          adviceList.appendChild(li);
        });
        
        // Simple charts for fallback
        renderFallbackCharts(data.history);
      }
      
      function renderCharts(overall, history) {
        // Score Gauge
        const gaugeCtx = document.getElementById('scoreGauge').getContext('2d');
        new Chart(gaugeCtx, {
          type: 'doughnut',
          data: {
            labels: ['Score', 'Remaining'],
            datasets: [{
              data: [overall.privacy_score, Math.max(0, 100 - overall.privacy_score)],
              backgroundColor: ['#22c55e', '#e5e7eb'],
              borderWidth: 0,
            }],
          },
          options: {
            circumference: 180,
            rotation: -90,
            cutout: '75%',
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
          },
          plugins: [{
            id: 'scoreLabel',
            afterDraw(chart) {
              const { ctx, chartArea: { width, height } } = chart;
              ctx.save();
              ctx.font = 'bold 24px Arial';
              ctx.fillStyle = '#111827';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText(`${overall.privacy_score}`, chart.getDatasetMeta(0).data[0].x, chart.getDatasetMeta(0).data[0].y + 10);
              ctx.restore();
            }
          }]
        });
        
        // Breakdown Chart
        const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
        const cookiesWeight = (overall.total_cookies || 0) * 0.05;
        const trackersWeight = (overall.total_trackers || 0) * 3;
        const permissionsWeight = (overall.total_permissions || []).length * 2;
        
        new Chart(breakdownCtx, {
          type: 'doughnut',
          data: {
            labels: ['Cookies', 'Trackers', 'Permissions'],
            datasets: [{
              data: [cookiesWeight, trackersWeight, permissionsWeight],
              backgroundColor: ['#60a5fa', '#f59e0b', '#10b981'],
            }],
          },
          options: {
            plugins: {
              legend: { position: 'bottom' },
            },
          },
        });
        
        // History Chart
        const historyCtx = document.getElementById('scoreChart').getContext('2d');
        new Chart(historyCtx, {
          type: 'line',
          data: {
            labels: (history || []).map((_, i) => `Scan ${i + 1}`),
            datasets: [{
              label: 'Privacy Score',
              data: (history || []).map(entry => entry.overall?.privacy_score || entry.score || 0),
              borderColor: '#2563eb',
              fill: false,
              tension: 0.4,
            }],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return `Scan ${context[0].label}`;
                  },
                  label: function(context) {
                    const index = context.dataIndex;
                    const entry = history[index];
                    if (entry && entry.overall) {
                      return [
                        `Privacy Score: ${entry.overall.privacy_score || 0}`,
                        `Tabs Scanned: ${entry.overall.tabs_scanned || 0}`,
                        `Total Cookies: ${entry.overall.total_cookies || 0}`,
                        `Total Trackers: ${entry.overall.total_trackers || 0}`,
                        `Total Permissions: ${(entry.overall.total_permissions || []).length}`
                      ];
                    } else if (entry) {
                      return [
                        `Privacy Score: ${entry.score || 0}`,
                        `Cookies: ${entry.cookies || 0}`,
                        `Trackers: ${entry.trackers || 0}`,
                        `Permissions: ${(entry.permissions || []).length}`
                      ];
                    }
                    return `Privacy Score: ${context.parsed.y}`;
                  }
                }
              }
            }
          },
        });
      }
      
      function renderFallbackCharts(history) {
        // Simple fallback charts
        const gaugeCtx = document.getElementById('scoreGauge').getContext('2d');
        const score = history && history.length ? history[history.length - 1].score : 0;
        
        new Chart(gaugeCtx, {
          type: 'doughnut',
          data: {
            labels: ['Score', 'Remaining'],
            datasets: [{
              data: [score, Math.max(0, 100 - score)],
              backgroundColor: ['#22c55e', '#e5e7eb'],
              borderWidth: 0,
            }],
          },
          options: {
            circumference: 180,
            rotation: -90,
            cutout: '75%',
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
          },
        });
        
        // History Chart
        const historyCtx = document.getElementById('scoreChart').getContext('2d');
        new Chart(historyCtx, {
          type: 'line',
          data: {
            labels: (history || []).map((_, i) => `Scan ${i + 1}`),
            datasets: [{
              label: 'Privacy Score',
              data: (history || []).map(entry => entry.score || 0),
              borderColor: '#2563eb',
              fill: false,
              tension: 0.4,
            }],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return `Scan ${context[0].label}`;
                  },
                  label: function(context) {
                    const index = context.dataIndex;
                    const entry = history[index];
                    if (entry) {
                      return [
                        `Privacy Score: ${entry.score || 0}`,
                        `Cookies: ${entry.cookies || 0}`,
                        `Trackers: ${entry.trackers || 0}`,
                        `Permissions: ${(entry.permissions || []).length}`
                      ];
                    }
                    return `Privacy Score: ${context.parsed.y}`;
                  }
                }
              }
            }
          },
        });
      }
      
      function renderTabsGrid() {
        if (!allTabsData || !allTabsData.latest || !allTabsData.latest.tabs) {
          document.getElementById('tabsLoading').innerHTML = '<div class="no-data"><h3>No tab data available</h3><p>Please run a comprehensive scan first.</p></div>';
          return;
        }
        
        const tabsGrid = document.getElementById('tabsGrid');
        tabsGrid.innerHTML = '';
        
        allTabsData.latest.tabs.forEach(tab => {
          const tabCard = document.createElement('div');
          tabCard.className = 'tab-card';
          tabCard.onclick = () => selectTab(tab);
          
          const scoreColor = tab.privacy_score >= 70 ? '#22c55e' : tab.privacy_score >= 40 ? '#f59e0b' : '#ef4444';
          
          tabCard.innerHTML = `
            <div class="tab-title" title="${tab.title}">${tab.title}</div>
            <div class="tab-domain">${tab.domain}</div>
            <div class="tab-stats">
              <div class="tab-stat">
                <div class="label">Cookies</div>
                <div class="value">${tab.cookies}</div>
              </div>
              <div class="tab-stat">
                <div class="label">Trackers</div>
                <div class="value">${tab.trackers}</div>
              </div>
              <div class="tab-stat">
                <div class="label">Permissions</div>
                <div class="value">${tab.permissions.length}</div>
              </div>
            </div>
            <div class="tab-score">
              <div class="label">Privacy Score</div>
              <div class="score-value" style="color: ${scoreColor}">${tab.privacy_score}</div>
            </div>
          `;
          
          tabsGrid.appendChild(tabCard);
        });
        
        document.getElementById('tabsLoading').style.display = 'none';
        document.getElementById('tabsContent').style.display = 'block';
      }
      
      function selectTab(tab) {
        // Remove previous selection
        document.querySelectorAll('.tab-card').forEach(card => card.classList.remove('selected'));
        
        // Add selection to clicked tab
        event.currentTarget.classList.add('selected');
        
        // You could add more detailed tab analysis here
        console.log('Selected tab:', tab);
      }
      
      // Load heatmap data
      async function loadHeatmapData() {
        try {
          console.log('Loading heatmap data...');
          
          // Try to get real data from extension first
          let extensionResult = null;
          try {
            extensionResult = await communicateWithExtension('getVisitedSites');
            console.log('Extension result:', extensionResult);
          } catch (extError) {
            console.warn('Error communicating with extension:', extError);
            // Continue to fallback
          }
          
          if (extensionResult && extensionResult.success && extensionResult.sites && extensionResult.sites.length > 0) {
            // Use real data from extension
            console.log('Using real extension data:', extensionResult.sites.length, 'sites');
            renderHeatmap(extensionResult.sites, true);
            document.getElementById('heatmapLoading').style.display = 'none';
            document.getElementById('heatmapContent').style.display = 'block';
          } else {
            console.log('No extension data, using backend fallback');
            // Fallback to backend data
            const res = await fetch('/visited_sites');
            const data = await res.json();
            console.log('Backend data:', data);
            
            if (data.sites && data.sites.length > 0) {
              renderHeatmap(data.sites, data.isRealData);
              document.getElementById('heatmapLoading').style.display = 'none';
              document.getElementById('heatmapContent').style.display = 'block';
            } else {
              document.getElementById('heatmapLoading').innerHTML = '<div class="no-data"><h3>No visited sites data available</h3><p>Start browsing to see your privacy heatmap.</p></div>';
            }
          }
        } catch (e) {
          console.error('Error loading heatmap data:', e);
          document.getElementById('heatmapLoading').innerHTML = '<div class="no-data"><h3>Error loading heatmap</h3><p>Please try again later.</p></div>';
        }
      }
      
      function renderHeatmap(sites, isRealData) {
        const heatmapGrid = document.getElementById('heatmapGrid');
        heatmapGrid.innerHTML = '';
        
        // Add data source indicator
        const dataSourceIndicator = document.createElement('div');
        dataSourceIndicator.style.cssText = `
          grid-column: 1 / -1;
          text-align: center;
          padding: 10px;
          margin-bottom: 15px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
        `;
        
        if (isRealData) {
          dataSourceIndicator.style.background = '#d1fae5';
          dataSourceIndicator.style.color = '#065f46';
          dataSourceIndicator.style.border = '1px solid #10b981';
          dataSourceIndicator.textContent = '‚úÖ Real browsing data from your extension';
        } else {
          dataSourceIndicator.style.background = '#fef3c7';
          dataSourceIndicator.style.color = '#92400e';
          dataSourceIndicator.style.border = '1px solid #f59e0b';
          dataSourceIndicator.textContent = '‚ö†Ô∏è Demo data - browse some websites to see real data';
        }
        
        heatmapGrid.appendChild(dataSourceIndicator);
        
        // Ensure sites is an array
        if (!Array.isArray(sites) || sites.length === 0) {
          const noDataMessage = document.createElement('div');
          noDataMessage.style.cssText = `
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 16px;
          `;
          noDataMessage.textContent = 'No site data available. Browse some websites to see your privacy heatmap.';
          heatmapGrid.appendChild(noDataMessage);
          return;
        }
        
        sites.forEach(site => {
          // Ensure site has all required properties with defaults
          const safeData = {
            domain: site.domain || 'Unknown Domain',
            title: site.title || site.domain || 'Unknown Site',
            riskScore: typeof site.riskScore === 'number' ? site.riskScore : 50,
            cookies: typeof site.cookies === 'number' ? site.cookies : 0,
            trackers: typeof site.trackers === 'number' ? site.trackers : 0,
            visits: typeof site.visits === 'number' ? site.visits : 1,
            lastVisit: site.lastVisit || new Date().toISOString()
          };
          
          const riskLevel = safeData.riskScore >= 70 ? 'low-risk' : safeData.riskScore >= 40 ? 'medium-risk' : 'high-risk';
          
          const heatmapItem = document.createElement('div');
          heatmapItem.className = `heatmap-item ${riskLevel}`;
          heatmapItem.onclick = () => showSiteDetails(safeData);
          
          let lastVisit;
          try {
            lastVisit = new Date(safeData.lastVisit).toLocaleDateString();
          } catch (e) {
            lastVisit = 'Unknown';
          }
          
          heatmapItem.innerHTML = `
            <div class="heatmap-domain">${safeData.domain}</div>
            <div class="heatmap-title" title="${safeData.title}">${safeData.title}</div>
            <div class="heatmap-stats">
              <div class="heatmap-stat">
                <div class="label">Cookies</div>
                <div class="value">${safeData.cookies}</div>
              </div>
              <div class="heatmap-stat">
                <div class="label">Trackers</div>
                <div class="value">${safeData.trackers}</div>
              </div>
              <div class="heatmap-stat">
                <div class="label">Visits</div>
                <div class="value">${safeData.visits}</div>
              </div>
              <div class="heatmap-stat">
                <div class="label">Last Visit</div>
                <div class="value">${lastVisit}</div>
              </div>
            </div>
            <div class="heatmap-score ${riskLevel}">
              Privacy Score: ${safeData.riskScore}
            </div>
          `;
          
          heatmapGrid.appendChild(heatmapItem);
        });
      }
      
      function showSiteDetails(site) {
        let lastVisit;
        try {
          lastVisit = new Date(site.lastVisit).toLocaleString();
        } catch (e) {
          lastVisit = 'Unknown';
        }
        
        alert(`Site Details:\n\nDomain: ${site.domain}\nTitle: ${site.title}\nPrivacy Score: ${site.riskScore}\nCookies: ${site.cookies}\nTrackers: ${site.trackers}\nTotal Visits: ${site.visits}\nLast Visit: ${lastVisit}`);
      }
      
      // Function to communicate with the extension
      async function communicateWithExtension(action) {
        return new Promise((resolve, reject) => {
          // Check if we're in a Chrome extension context
          if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {
            try {
              chrome.runtime.sendMessage({ action: action }, function(response) {
                if (chrome.runtime.lastError) {
                  console.error('Extension communication error:', chrome.runtime.lastError);
                  resolve({ success: false, error: chrome.runtime.lastError.message });
                  return;
                }
                resolve(response || { success: false, error: 'No response from extension' });
              });
            } catch (err) {
              console.error('Error sending message to extension:', err);
              resolve({ success: false, error: err.message });
            }
          } else {
            // Try to inject script into the page to communicate with extension
            const script = document.createElement('script');
            script.textContent = `
              (function() {
                if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {
                  chrome.runtime.sendMessage({ action: '${action}' }, (response) => {
                    window.extensionResponse = response || { success: false, error: 'No response' };
                  });
                } else {
                  window.extensionResponse = { success: false, error: 'Extension not available' };
                }
              })();
            `;
            document.head.appendChild(script);
            
            // Wait for response
            setTimeout(() => {
              const response = window.extensionResponse || { success: false, error: 'Extension not available' };
              document.head.removeChild(script);
              resolve(response);
            }, 1000);
          }
        });
      }
      
      // Dashboard Action Center Event Listeners
      document.getElementById('dashboardClearCookies').addEventListener('click', async () => {
        const btn = document.getElementById('dashboardClearCookies');
        const status = document.getElementById('dashboardActionStatus');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Clearing...</span>';
        status.textContent = 'Clearing cookies...';
        status.className = 'action-status loading';
        
        try {
          // Try to communicate with the extension first
          const extensionResult = await communicateWithExtension('clearCookies');
          
          if (extensionResult.success) {
            status.textContent = `‚úÖ Successfully cleared ${extensionResult.cleared} cookies (via extension)`;
            status.className = 'action-status success';
          } else {
            // Fallback to backend simulation
            const response = await fetch('/clear_cookies', { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
              status.textContent = `‚ö†Ô∏è Simulated: Cleared ${result.cleared} cookies (extension not available)`;
              status.className = 'action-status success';
            } else {
              throw new Error(result.error || 'Failed to clear cookies');
            }
          }
        } catch (err) {
          status.textContent = `‚ùå Error: ${err.message}`;
          status.className = 'action-status error';
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<span class="btn-icon">üßπ</span><span class="btn-text">Clear Cookies</span>';
        }
      });
      
      document.getElementById('dashboardBlockTrackers').addEventListener('click', async () => {
        const btn = document.getElementById('dashboardBlockTrackers');
        const status = document.getElementById('dashboardActionStatus');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Blocking...</span>';
        status.textContent = 'Enabling tracker blocking...';
        status.className = 'action-status loading';
        
        try {
          // Try to communicate with the extension first
          const extensionResult = await communicateWithExtension('blockTrackers');
          
          if (extensionResult.success) {
            status.textContent = '‚úÖ Tracker blocking enabled successfully (via extension)';
            status.className = 'action-status success';
            btn.innerHTML = '<span class="btn-icon">üö´</span><span class="btn-text">Blocking Active</span>';
          } else {
            // Fallback to backend simulation
            const response = await fetch('/block_trackers', { 
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ enabled: true })
            });
            const result = await response.json();
            
            if (result.success) {
              status.textContent = '‚ö†Ô∏è Simulated: Tracker blocking enabled (extension not available)';
              status.className = 'action-status success';
              btn.innerHTML = '<span class="btn-icon">üö´</span><span class="btn-text">Blocking Active</span>';
            } else {
              throw new Error(result.error || 'Failed to enable tracker blocking');
            }
          }
        } catch (err) {
          status.textContent = `‚ùå Error: ${err.message}`;
          status.className = 'action-status error';
        } finally {
          btn.disabled = false;
        }
      });
      
      document.getElementById('dashboardOptimize').addEventListener('click', async () => {
        const btn = document.getElementById('dashboardOptimize');
        const status = document.getElementById('dashboardActionStatus');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Optimizing...</span>';
        status.textContent = 'Running privacy optimizations...';
        status.className = 'action-status loading';
        
        try {
          // Try to communicate with the extension first
          const extensionResult = await communicateWithExtension('optimizeSettings');
          
          if (extensionResult.success) {
            const optimizations = extensionResult.optimizations.join(', ');
            status.textContent = `‚úÖ Optimized (via extension): ${optimizations}`;
            status.className = 'action-status success';
          } else {
            // Fallback to backend simulation
            const response = await fetch('/optimize_settings', { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
              const optimizations = result.optimizations.join(', ');
              status.textContent = `‚ö†Ô∏è Simulated: ${optimizations} (extension not available)`;
              status.className = 'action-status success';
            } else {
              throw new Error(result.error || 'Failed to optimize settings');
            }
          }
        } catch (err) {
          status.textContent = `‚ùå Error: ${err.message}`;
          status.className = 'action-status error';
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<span class="btn-icon">‚ö°</span><span class="btn-text">Optimize Settings</span>';
        }
      });
      
      // Load data on page load
      loadOverviewData();
    </script>
  </body>
</html>
